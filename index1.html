<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Trading Alarm</title>
<!-- Lightweight Charts para gráfico velas -->
<script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.2/dist/lightweight-charts.standalone.production.js"></script>
<!-- Axios para llamadas HTTP -->
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<!-- TailwindCSS CDN para estilos -->
<script src="https://cdn.tailwindcss.com"></script>
<style>
  /* Estilo modo dark tipo Binance */
  body {
    background-color: #0b1421;
    color: #d0d6f9;
    margin: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  header {
    text-align: center;
    font-size: 1.8rem;
    font-weight: 700;
    padding: 1rem 0;
    background: #131d2d;
    border-bottom: 1px solid #28374d;
    user-select: none;
  }
  #main-container {
    flex: 1;
    display: flex;
    height: calc(100vh - 56px); /* Header 56px */
    overflow: hidden;
  }
  #trading-data {
    width: 20%;
    background: #131d2d;
    border-right: 1px solid #28374d;
    overflow-y: auto;
    padding: 0.5rem 1rem;
    display: flex;
    flex-direction: column;
  }
  #trading-data h2 {
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: #d0d6f9;
  }
  #coin-list {
    list-style: none;
    padding: 0;
    margin: 0;
    flex: 1;
    overflow-y: auto;
  }
  #coin-list li {
    display: flex;
    justify-content: space-between;
    padding: 0.35rem 0.25rem;
    border-bottom: 1px solid #28374d;
    cursor: pointer;
    font-size: 0.85rem;
    color: #a4acc4;
  }
  #coin-list li.selected {
    background: #2a3a5a;
    color: #fff;
    font-weight: 700;
  }
  #coin-list li:hover {
    background: #2a3a5a;
    color: #fff;
  }
  #trading-live {
    flex: 1;
    background: #0b1421;
    position: relative;
    display: flex;
    flex-direction: column;
  }
  #chart {
    flex: 1;
    min-height: 0;
  }
  #trading-conf {
    height: 12.5vh; /* 1/8 pantalla */
    background: #131d2d;
    border-top: 1px solid #28374d;
    display: flex;
    align-items: center;
    padding-left: 1rem;
    gap: 0.5rem;
  }
  button.conf-btn {
    background: #28374d;
    color: #d0d6f9;
    border: none;
    padding: 0.45rem 0.85rem;
    font-size: 0.85rem;
    font-weight: 600;
    border-radius: 0.25rem;
    cursor: pointer;
    user-select: none;
    height: 2.2rem;
    min-width: 6rem;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  button.conf-btn:hover {
    background: #3a4f7a;
  }
  /* Scroll personalizado */
  #coin-list::-webkit-scrollbar {
    width: 7px;
  }
  #coin-list::-webkit-scrollbar-thumb {
    background: #28374d;
    border-radius: 3.5px;
  }
  #coin-list::-webkit-scrollbar-track {
    background: #131d2d;
  }
  /* Popup overlay */
  .popup-overlay {
    position: fixed;
    inset: 0;
    background: rgba(11, 20, 33, 0.85);
    display: flex;
    justify-content: center;
    align-items: start;
    padding: 2rem 1rem;
    z-index: 1000;
    overflow-y: auto;
  }
  .popup {
    background: #131d2d;
    border: 1px solid #28374d;
    border-radius: 0.4rem;
    padding: 1rem 1.2rem 1.5rem 1.2rem;
    width: 320px;
    max-width: 95vw;
    box-shadow: 0 0 12px #1f2a4daa;
    color: #d0d6f9;
    user-select: none;
  }
  .popup-header {
    font-weight: 700;
    font-size: 1.2rem;
    margin-bottom: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .popup-close {
    cursor: pointer;
    font-size: 1.2rem;
    font-weight: 700;
    color: #d0d6f9;
    padding: 0 0.2rem;
    border-radius: 50%;
    user-select: none;
    transition: background 0.2s ease;
  }
  .popup-close:hover {
    background: #3a4f7a;
  }
  select, input[type=number], input[type=checkbox] {
    background: #28374d;
    border: none;
    border-radius: 0.25rem;
    color: #d0d6f9;
    padding: 0.4rem 0.6rem;
    font-size: 1rem;
    width: 100%;
    box-sizing: border-box;
    margin-bottom: 1rem;
    user-select: none;
  }
  label {
    display: block;
    margin-bottom: 0.3rem;
    font-weight: 600;
    font-size: 0.9rem;
  }
  .btn-group {
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
  }
  .popup button {
    background: #3a4f7a;
    border: none;
    padding: 0.45rem 1rem;
    border-radius: 0.25rem;
    color: #d0d6f9;
    font-weight: 600;
    cursor: pointer;
    user-select: none;
    transition: background 0.2s ease;
  }
  .popup button:hover {
    background: #4a5f9a;
  }
  .threshold-label {
    font-size: 0.8rem;
    color: #a4acc4;
    font-weight: 600;
    user-select: none;
    position: relative;
    top: -22px;
    background: #0b1421dd;
    padding: 0 4px;
    border-radius: 2px;
  }
  /* Responsive */
  @media (max-width: 768px) {
    #trading-data {
      width: 35%;
    }
    #trading-conf {
      height: 14vh;
    }
  }
</style>
</head>
<body>

<header>Trading Alarm</header>

<div id="main-container">
  <aside id="trading-data" aria-label="Trading Data">
    <h2>Trading Data</h2>
    <ul id="coin-list" role="listbox" aria-label="Listado de criptomonedas populares">
      <!-- Se rellena dinámicamente -->
    </ul>
  </aside>

  <section id="trading-live" aria-label="Trading Live">
    <div id="chart"></div>
  </section>
</div>

<footer id="trading-conf" aria-label="Trading Configuration">
  <button id="btn-cryptos" class="conf-btn" aria-haspopup="dialog" aria-controls="popup-container">Criptomonedas</button>
  <button id="btn-thresholds" class="conf-btn" aria-haspopup="dialog" aria-controls="popup-container">Umbrales</button>
  <button id="btn-alerts" class="conf-btn" aria-haspopup="dialog" aria-controls="popup-container">Alertas</button>
</footer>

<div id="popup-container" role="dialog" aria-modal="true" aria-hidden="true" style="display:none;"></div>

<script>
(() => {
  // VARIABLES GLOBALES Y CONFIG

  const API_BINANCE = 'https://api.binance.com/api/v3';
  let selectedSymbol = localStorage.getItem('selectedSymbol') || 'BTCUSDT';
  let thresholds = JSON.parse(localStorage.getItem('thresholds')) || { min: -2, max: 2 };
  let alertRealTime = JSON.parse(localStorage.getItem('alertRealTime')) ?? true;

  let coinListData = [];
  let reconnectDelay = 1000;
  let reconnectMaxDelay = 60000;

  // Gráfico
  let chart, candleSeries, maxLine, minLine;
  let lastCandleTime = 0;
  let chartReady = false;

  // Elementos UI
  const coinListEl = document.getElementById('coin-list');
  const popupContainer = document.getElementById('popup-container');
  const btnCryptos = document.getElementById('btn-cryptos');
  const btnThresholds = document.getElementById('btn-thresholds');
  const btnAlerts = document.getElementById('btn-alerts');

  // --- UTILIDADES ---
  function sleep(ms) { return new Promise(res => setTimeout(res, ms)); }

  // Manejo seguro localStorage con fallback
  function safeSetItem(key, val) {
    try { localStorage.setItem(key, JSON.stringify(val)); } catch {}
  }
  function safeGetItem(key, def) {
    try {
      const val = localStorage.getItem(key);
      return val ? JSON.parse(val) : def;
    } catch { return def; }
  }

  // --- FUNCIONES API BINANCE ---

  async function fetchWithRetry(url, retries = 3, delay = 1000) {
    for (let i=0; i<=retries; i++) {
      try {
        const res = await axios.get(url, {timeout: 7000});
        if(res.status === 200) return res.data;
        throw new Error(`HTTP ${res.status}`);
      } catch(e) {
        if(i === retries) throw e;
        await sleep(delay);
        delay = Math.min(delay*2, reconnectMaxDelay);
      }
    }
  }

  // Obtener listado monedas populares (top 30 por volumen en USDT)
  async function fetchPopularCoins() {
    // Obtener tickers USDT con volumen (top 30)
    const url = `${API_BINANCE}/ticker/24hr`;
    try {
      const data = await fetchWithRetry(url);
      // Filtrar solo pares USDT y ordenar por volumen desc
      const usdtPairs = data.filter(t => t.symbol.endsWith('USDT'));
      usdtPairs.sort((a,b) => parseFloat(b.quoteVolume) - parseFloat(a.quoteVolume));
      const top30 = usdtPairs.slice(0,30);
      coinListData = top30.map(c => ({
        symbol: c.symbol,
        baseAsset: c.symbol.replace('USDT',''),
        lastPrice: parseFloat(c.lastPrice),
        priceChangePercent: parseFloat(c.priceChangePercent),
      }));
    } catch (e) {
      showError(`Error cargando monedas populares: ${e.message}`);
      // fallback mínimo con BTCUSDT solo
      coinListData = [{
        symbol:'BTCUSDT',
        baseAsset:'BTC',
        lastPrice: 0,
        priceChangePercent: 0
      }];
    }
  }

  // Obtener datos vela inicial (últimas 100 velas 1m)
  async function fetchInitialCandles(symbol) {
    try {
      const klines = await fetchWithRetry(`${API_BINANCE}/klines?symbol=${symbol}&interval=1m&limit=100`);
      return klines.map(k => ({
        time: Math.floor(k[0]/1000),
        open: parseFloat(k[1]),
        high: parseFloat(k[2]),
        low: parseFloat(k[3]),
        close: parseFloat(k[4]),
        volume: parseFloat(k[5])
      }));
    } catch(e) {
      showError(`Error cargando velas iniciales: ${e.message}`);
      return [];
    }
  }

  // --- UI RENDER ---

  // Mostrar listado monedas
  function renderCoinList() {
    coinListEl.innerHTML = '';
    coinListData.forEach(c => {
      const li = document.createElement('li');
      li.setAttribute('role', 'option');
      li.setAttribute('aria-selected', (c.symbol === selectedSymbol).toString());
      li.classList.toggle('selected', c.symbol === selectedSymbol);
      li.title = `${c.baseAsset} - Precio: ${c.lastPrice.toFixed(4)} USDT - Cambio 24h: ${c.priceChangePercent.toFixed(2)}%`;
      li.textContent = `${c.baseAsset} | ${c.lastPrice.toFixed(4)} USDT | ${c.priceChangePercent.toFixed(2)}%`;
      li.addEventListener('click', () => {
        alert('Solo puede seleccionar una moneda. Use el botón "Criptomonedas" para cambiar.');
      });
      coinListEl.appendChild(li);
    });
  }

  // Mostrar error en pantalla (toast o alert)
  function showError(msg) {
    alert(msg);
  }

  // --- POPUPS ---

  function closePopup() {
    popupContainer.style.display = 'none';
    popupContainer.innerHTML = '';
    popupContainer.setAttribute('aria-hidden', 'true');
  }

  // Popup selector criptomonedas
  function openCryptoPopup() {
    popupContainer.style.display = 'flex';
    popupContainer.setAttribute('aria-hidden', 'false');
    popupContainer.innerHTML = `
      <div class="popup" role="document" aria-label="Selector de criptomonedas">
        <div class="popup-header">
          <span>Seleccionar Criptomoneda</span>
          <button class="popup-close" aria-label="Cerrar selector de criptomonedas">&times;</button>
        </div>
        <p style="font-size:0.9rem; margin-bottom: 0.6rem; color:#a4acc4;">Solo puede seleccionar una moneda. La configuración actual será reemplazada.</p>
        <select id="crypto-select" size="10" style="width: 100%; user-select:none;">
          ${coinListData.map(c => `<option value="${c.symbol}" ${c.symbol === selectedSymbol ? 'selected':''}>${c.baseAsset} (${c.symbol})</option>`).join('')}
        </select>
        <div class="btn-group">
          <button id="crypto-cancel">Cerrar sin guardar</button>
          <button id="crypto-save">Guardar selección</button>
        </div>
      </div>
    `;
    const closeBtn = popupContainer.querySelector('.popup-close');
    const cancelBtn = document.getElementById('crypto-cancel');
    const saveBtn = document.getElementById('crypto-save');
    const selectEl = document.getElementById('crypto-select');

    closeBtn.onclick = cancelBtn.onclick = () => closePopup();
    saveBtn.onclick = () => {
      const val = selectEl.value;
      if(!val) {
        alert('Debe seleccionar una moneda o cerrar sin guardar.');
        return;
      }
      selectedSymbol = val;
      safeSetItem('selectedSymbol', selectedSymbol);
      // Reset thresholds a default
      thresholds = { min: -2, max: 2 };
      safeSetItem('thresholds', thresholds);
      closePopup();
      loadSymbolData(selectedSymbol);
    };
  }

  // Popup umbrales
  function openThresholdPopup() {
    popupContainer.style.display = 'flex';
    popupContainer.setAttribute('aria-hidden', 'false');
    popupContainer.innerHTML = `
      <div class="popup" role="document" aria-label="Configurar umbrales">
        <div class="popup-header">
          <span>Configurar Umbrales (%)</span>
          <button class="popup-close" aria-label="Cerrar configuración de umbrales">&times;</button>
        </div>
        <label for="threshold-min">Umbral mínimo (%) inferior</label>
        <input type="number" id="threshold-min" step="0.1" min="-100" max="0" value="${thresholds.min}" />
        <label for="threshold-max">Umbral máximo (%) superior</label>
        <input type="number" id="threshold-max" step="0.1" min="0" max="100" value="${thresholds.max}" />
        <div class="btn-group">
          <button id="threshold-cancel">Cerrar sin guardar</button>
          <button id="threshold-save">Guardar</button>
        </div>
      </div>
    `;
    const closeBtn = popupContainer.querySelector('.popup-close');
    const cancelBtn = document.getElementById('threshold-cancel');
    const saveBtn = document.getElementById('threshold-save');
    const minInput = document.getElementById('threshold-min');
    const maxInput = document.getElementById('threshold-max');

    closeBtn.onclick = cancelBtn.onclick = () => closePopup();
    saveBtn.onclick = () => {
      const minVal = parseFloat(minInput.value);
      const maxVal = parseFloat(maxInput.value);
      if(isNaN(minVal) || isNaN(maxVal) || minVal >= 0 || maxVal <= 0) {
        alert('Umbrales inválidos. Mínimo debe ser negativo y máximo positivo.');
        return;
      }
      thresholds.min = minVal;
      thresholds.max = maxVal;
      safeSetItem('thresholds', thresholds);
      closePopup();
      drawThresholdLines();
    };
  }

  // Popup alertas
  function openAlertPopup() {
    popupContainer.style.display = 'flex';
    popupContainer.setAttribute('aria-hidden', 'false');
    popupContainer.innerHTML = `
      <div class="popup" role="document" aria-label="Configurar alertas">
        <div class="popup-header">
          <span>Configurar Alertas</span>
          <button class="popup-close" aria-label="Cerrar configuración de alertas">&times;</button>
        </div>
        <fieldset style="border:none; padding:0; margin:0;">
          <legend style="font-weight:600; margin-bottom:0.5rem;">Alertas en tiempo real</legend>
          <label><input type="checkbox" id="alert-real-time" ${alertRealTime ? 'checked':''}/> Habilitar alertas emergentes al alcanzar umbrales</label>
        </fieldset>
        <fieldset style="border:none; padding:0; margin-top: 1rem;">
          <legend style="font-weight:600; margin-bottom:0.5rem;">Alertas por email</legend>
          <p style="color:#a4acc4; font-size:0.9rem;">(No implementado)</p>
        </fieldset>
        <div class="btn-group" style="margin-top:1rem;">
          <button id="alert-cancel">Cerrar sin guardar</button>
          <button id="alert-save">Guardar</button>
        </div>
      </div>
    `;
    const closeBtn = popupContainer.querySelector('.popup-close');
    const cancelBtn = document.getElementById('alert-cancel');
    const saveBtn = document.getElementById('alert-save');
    const alertCheck = document.getElementById('alert-real-time');

    closeBtn.onclick = cancelBtn.onclick = () => closePopup();
    saveBtn.onclick = () => {
      alertRealTime = alertCheck.checked;
      safeSetItem('alertRealTime', alertRealTime);
      closePopup();
    };
  }

  // --- GRAFICO ---

  // Inicializar gráfico con configuración tipo Binance
  function initChart() {
    if(chart) {
      chart.remove();
      chart = null;
      candleSeries = null;
      maxLine = null;
      minLine = null;
    }
    const container = document.getElementById('chart');
    container.innerHTML = '';
    chart = LightweightCharts.createChart(container, {
      width: container.clientWidth,
      height: container.clientHeight,
      layout: {
        backgroundColor: '#0b1421',
        textColor: '#d0d6f9',
      },
      grid: {
        vertLines: {
          color: '#28374d',
        },
        horzLines: {
          color: '#28374d',
        },
      },
      rightPriceScale: {
        borderColor: '#28374d',
      },
      timeScale: {
        borderColor: '#28374d',
        timeVisible: true,
        secondsVisible: false,
      },
      crosshair: {
        mode: LightweightCharts.CrosshairMode.Normal,
      },
      localization: {
        locale: 'es-ES',
      }
    });
    candleSeries = chart.addCandlestickSeries({
      upColor: '#4a9b4a',
      downColor: '#d94242',
      borderDownColor: '#d94242',
      borderUpColor: '#4a9b4a',
      wickDownColor: '#d94242',
      wickUpColor: '#4a9b4a',
    });

    // Ajuste de tamaño responsive
    window.addEventListener('resize', () => {
      chart.applyOptions({ width: container.clientWidth, height: container.clientHeight });
      chart.timeScale().fitContent();
    });

    chartReady = true;
  }

  // Añadir líneas umbral y etiquetas
  function drawThresholdLines() {
    if(!chartReady) return;
    // Remover líneas previas
    if(maxLine) candleSeries.removePriceLine(maxLine);
    if(minLine) candleSeries.removePriceLine(minLine);

    // Buscar último precio cierre vela
    const candles = candleSeries.data();
    if(!candles.length) return;

    const lastClose = candles[candles.length-1].close;

    const minValue = +(lastClose * (1 + thresholds.min/100)).toFixed(6);
    const maxValue = +(lastClose * (1 + thresholds.max/100)).toFixed(6);

    minLine = candleSeries.createPriceLine({
      price: minValue,
      color: '#d94242',
      lineWidth: 2,
      lineStyle: LightweightCharts.LineStyle.Dashed,
      axisLabelVisible: true,
      title: `Umbral mínimo: ${thresholds.min}% (${minValue.toFixed(4)})`,
    });
    maxLine = candleSeries.createPriceLine({
      price: maxValue,
      color: '#4a9b4a',
      lineWidth: 2,
      lineStyle: LightweightCharts.LineStyle.Dashed,
      axisLabelVisible: true,
      title: `Umbral máximo: ${thresholds.max}% (${maxValue.toFixed(4)})`,
    });
  }

  // Actualizar datos de precio y detectar alertas
  function processRealtimePrice(newCandle) {
    // Actualizamos vela en gráfico
    if (!chartReady) return;
    const candles = candleSeries.data();
    if(!candles.length || newCandle.time > candles[candles.length-1].time) {
      candleSeries.update(newCandle);
    } else {
      candleSeries.update(newCandle);
    }

    drawThresholdLines();

    if(alertRealTime) {
      // Revisar umbrales para alertar
      if(newCandle.close <= candles[candles.length-1].close * (1 + thresholds.min/100)) {
        showAlert(`Alerta: Precio bajó al umbral mínimo (${thresholds.min}%)`);
      } else if(newCandle.close >= candles[candles.length-1].close * (1 + thresholds.max/100)) {
        showAlert(`Alerta: Precio subió al umbral máximo (${thresholds.max}%)`);
      }
    }
  }

  // Mostrar alerta emergente (toast simple)
  let alertTimeout;
  function showAlert(msg) {
    clearTimeout(alertTimeout);
    let alertEl = document.getElementById('alert-toast');
    if(!alertEl) {
      alertEl = document.createElement('div');
      alertEl.id = 'alert-toast';
      alertEl.style.cssText = 'position:fixed; bottom:20px; right:20px; background:#4a9b4a; color:#fff; padding:1rem 1.5rem; border-radius:0.4rem; font-weight:700; box-shadow: 0 0 10px #4a9b4a;';
      document.body.appendChild(alertEl);
    }
    alertEl.textContent = msg;
    alertEl.style.opacity = '1';
    alertTimeout = setTimeout(() => {
      alertEl.style.opacity = '0';
    }, 3500);
  }

  // WebSocket conexión para velas 1m en tiempo real
  let ws;
  function startWebSocket(symbol) {
    if(ws) {
      ws.close();
      ws = null;
    }
    const baseSymbol = symbol.toLowerCase();
    const stream = `${baseSymbol}@kline_1m`;
    ws = new WebSocket(`wss://stream.binance.com:9443/ws/${stream}`);

    ws.onopen = () => {
      reconnectDelay = 1000; // reset delay al conectar
    };

    ws.onmessage = event => {
      try {
        const data = JSON.parse(event.data);
        if(data.k) {
          const k = data.k;
          const candle = {
            time: k.t / 1000,
            open: parseFloat(k.o),
            high: parseFloat(k.h),
            low: parseFloat(k.l),
            close: parseFloat(k.c),
            volume: parseFloat(k.v)
          };
          processRealtimePrice(candle);
        }
      } catch(e) {
        showError('Error procesando datos websocket: ' + e.message);
      }
    };

    ws.onerror = () => {
      ws.close();
    };

    ws.onclose = () => {
      // Reintento con backoff exponencial
      setTimeout(() => {
        reconnectDelay = Math.min(reconnectDelay * 2, reconnectMaxDelay);
        startWebSocket(symbol);
      }, reconnectDelay);
    };
  }

  // Cargar símbolo seleccionado: cargar datos y gráfico
  async function loadSymbolData(symbol) {
    try {
      initChart();
      const klines = await fetchKlines(symbol);
      candleSeries.setData(klines);
      drawThresholdLines();
      startWebSocket(symbol);
    } catch(e) {
      showError(`Error cargando datos para ${symbol}: ${e.message}`);
    }
  }

  // --- CONFIG STORAGE ---

  function safeSetItem(key, value) {
    try {
      localStorage.setItem(key, JSON.stringify(value));
    } catch(e) {
      showError('Error guardando configuración local: ' + e.message);
    }
  }

  function safeGetItem(key, def = null) {
    try {
      const val = localStorage.getItem(key);
      return val ? JSON.parse(val) : def;
    } catch(e) {
      return def;
    }
  }

  // --- INIT ---

  async function init() {
    // Cargar lista monedas populares
    try {
      coinListData = await fetchCoinList();
    } catch(e) {
      showError('No se pudo cargar la lista de criptomonedas. Compruebe conexión.');
      coinListData = [];
    }
    // Cargar configuraciones previas o default
    selectedSymbol = safeGetItem('selectedSymbol', 'BTCUSDT');
    thresholds = safeGetItem('thresholds', { min: -2, max: 2 });
    alertRealTime = safeGetItem('alertRealTime', true);

    renderCoinList();
    loadSymbolData(selectedSymbol);
  }

  init();

  // Eventos botones
  document.getElementById('btn-crypto').onclick = openCryptoPopup;
  document.getElementById('btn-threshold').onclick = openThresholdPopup;
  document.getElementById('btn-alert').onclick = openAlertPopup;

})();
</script>
</body>
</html>

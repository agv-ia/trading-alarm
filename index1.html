<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Trading Alarm</title>
<!-- Binance Dark style básico -->
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');

  * {
    box-sizing: border-box;
  }
  body, html {
    margin:0; padding:0; height:100%;
    font-family: 'Inter', sans-serif;
    background-color: #0b1421;
    color: #d0d6f9;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }
  #app {
    display: grid;
    grid-template-columns: 20% 1fr;
    grid-template-rows: 1fr 12.5%;
    height: 100vh;
    gap: 0;
  }

  /* Title centered top spanning all columns */
  header {
    grid-column: 1 / 3;
    height: 50px;
    background: #121f3a;
    display: flex;
    justify-content: center;
    align-items: center;
    font-weight: 700;
    font-size: 1.4rem;
    letter-spacing: 0.06em;
    border-bottom: 1px solid #28374d;
    user-select: none;
    z-index: 20;
  }

  /* Left sidebar: Trading Data */
  #trading-data {
    background: #121f3a;
    border-right: 1px solid #28374d;
    overflow-y: auto;
    padding: 0.5rem 0.4rem;
    font-size: 0.85rem;
  }
  #trading-data h2 {
    margin: 0 0 0.7rem 0;
    font-weight: 600;
    padding-left: 0.6rem;
  }
  #coin-list {
    list-style: none;
    margin: 0; padding: 0;
  }
  #coin-list li {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.3rem 0.5rem;
    border-radius: 4px;
    cursor: pointer;
    user-select:none;
    transition: background 0.2s ease;
    font-weight: 600;
  }
  #coin-list li.selected {
    background-color: #273653;
  }
  #coin-list li:hover {
    background-color: #1b2947;
  }
  #coin-list .coin-symbol {
    flex-shrink: 0;
    width: 60px;
  }
  #coin-list .coin-price {
    width: 75px;
    text-align: right;
  }
  #coin-list .coin-change {
    width: 50px;
    text-align: right;
  }
  #coin-list .change-positive {
    color: #4caf50;
  }
  #coin-list .change-negative {
    color: #e85656;
  }

  /* Bottom config bar */
  #trading-conf {
    grid-column: 2 / 3;
    background: #121f3a;
    border-top: 1px solid #28374d;
    display: flex;
    align-items: center;
    padding: 0 1rem;
    gap: 12px;
  }
  #trading-conf button {
    background: #0b1421;
    border: 1px solid #28374d;
    color: #d0d6f9;
    padding: 0.25rem 0.9rem;
    font-weight: 600;
    font-size: 0.85rem;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.3s ease;
    user-select:none;
  }
  #trading-conf button:hover {
    background-color: #28374d;
  }
  #trading-conf button:focus-visible {
    outline: 2px solid #4a9b4a;
  }
  #trading-conf button:active {
    background-color: #3a4f6e;
  }

  /* Trading Live area (center-top) */
  #trading-live {
    grid-column: 2 / 3;
    grid-row: 1 / 2;
    position: relative;
    background: #0b1421;
    border-bottom: 1px solid #28374d;
    padding: 0.2rem;
  }

  /* Popup overlay */
  #popup-container {
    display: none;
    position: fixed;
    inset: 0;
    background-color: rgba(11, 20, 33, 0.85);
    backdrop-filter: blur(5px);
    z-index: 1000;
    justify-content: center;
    align-items: center;
  }
  #popup-container[aria-hidden="false"] {
    display: flex;
  }
  .popup {
    background: #121f3a;
    border-radius: 6px;
    box-shadow: 0 0 20px rgba(74, 155, 74, 0.5);
    width: 320px;
    max-height: 80vh;
    overflow-y: auto;
    color: #d0d6f9;
    display: flex;
    flex-direction: column;
    font-size: 0.9rem;
  }
  .popup-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #28374d;
    padding: 0.6rem 1rem;
    font-weight: 700;
    font-size: 1rem;
    user-select:none;
  }
  .popup-close {
    cursor: pointer;
    background: transparent;
    border: none;
    font-size: 1.5rem;
    color: #d0d6f9;
    font-weight: 700;
    line-height: 1;
    padding: 0;
    transition: color 0.2s ease;
  }
  .popup-close:hover, .popup-close:focus-visible {
    color: #4a9b4a;
    outline:none;
  }
  .popup-body {
    padding: 1rem;
    flex-grow: 1;
  }
  .btn-group {
    display: flex;
    justify-content: flex-end;
    gap: 0.8rem;
    padding: 0.7rem 1rem 1rem;
  }
  .btn-group button {
    padding: 0.3rem 1rem;
    font-weight: 600;
    border-radius: 4px;
    border: 1px solid #28374d;
    background: #0b1421;
    color: #d0d6f9;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  .btn-group button:hover {
    background-color: #28374d;
  }
  .btn-group button:focus-visible {
    outline: 2px solid #4a9b4a;
  }
  .popup-body label {
    display: block;
    margin-top: 0.7rem;
    margin-bottom: 0.3rem;
  }
  .popup-body input[type="number"], .popup-body select {
    width: 100%;
    padding: 0.4rem 0.6rem;
    font-size: 1rem;
    border-radius: 4px;
    border: 1px solid #28374d;
    background: #0b1421;
    color: #d0d6f9;
  }

  /* Alert toast */
  #alert-toast {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #4a9b4a;
    color: #fff;
    padding: 1rem 1.5rem;
    border-radius: 0.4rem;
    font-weight: 700;
    box-shadow: 0 0 10px #4a9b4a;
    opacity: 0;
    transition: opacity 0.5s ease;
    user-select:none;
    z-index: 2000;
  }

  /* Scrollbar for side list */
  #coin-list::-webkit-scrollbar {
    width: 8px;
  }
  #coin-list::-webkit-scrollbar-thumb {
    background: #28374d;
    border-radius: 4px;
  }
  #coin-list::-webkit-scrollbar-track {
    background: transparent;
  }

  /* Responsive adjustments */
  @media (max-width: 700px) {
    #app {
      grid-template-columns: 1fr;
      grid-template-rows: 50px auto 8rem;
    }
    header {
      grid-column: 1 / 2;
    }
    #trading-data {
      grid-row: 2 / 3;
      width: 100%;
      height: 180px;
      border-right: none;
      border-bottom: 1px solid #28374d;
      overflow-x: auto;
      overflow-y: hidden;
      display: flex;
      flex-wrap: nowrap;
      padding: 0.3rem 0.3rem 0.3rem 0.3rem;
    }
    #coin-list {
      display: flex;
      flex-wrap: nowrap;
      gap: 0.5rem;
    }
    #coin-list li {
      flex: 0 0 auto;
      min-width: 150px;
      border-radius: 6px;
      padding: 0.5rem 0.7rem;
      font-size: 0.8rem;
      flex-direction: column;
      justify-content: center;
      align-items: flex-start;
    }
    #coin-list .coin-price,
    #coin-list .coin-change,
    #coin-list .coin-symbol {
      width: auto;
      text-align: left;
      font-weight: 600;
    }
    #trading-live {
      grid-row: 3 / 4;
      grid-column: 1 / 2;
      height: 300px;
      border-bottom: none;
      border-top: 1px solid #28374d;
    }
    #trading-conf {
      grid-column: 1 / 2;
      height: auto;
      padding: 0.7rem 1rem;
      justify-content: center;
      gap: 20px;
    }
  }
</style>
<!-- LightweightCharts CDN -->
<script src="https://unpkg.com/lightweight-charts@4.0.0/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>
<header>Trading Alarm</header>
<div id="app">
  <aside id="trading-data" aria-label="Trading Data">
    <h2>Trading Data</h2>
    <ul id="coin-list" role="listbox" aria-multiselectable="false" tabindex="0" aria-label="Lista de criptomonedas populares"></ul>
  </aside>
  <main id="trading-live" aria-label="Trading Live Chart"></main>
  <section id="trading-conf" aria-label="Trading Configuración">
    <button id="btn-crypto" aria-haspopup="dialog" aria-controls="popup-container">Criptomonedas</button>
    <button id="btn-threshold" aria-haspopup="dialog" aria-controls="popup-container">Umbrales</button>
    <button id="btn-alert" aria-haspopup="dialog" aria-controls="popup-container">Alertas</button>
  </section>
</div>

<!-- Popup container -->
<div id="popup-container" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="popup-title">
  <!-- Dynamic content inserted here -->
</div>

<!-- Alert toast -->
<div id="alert-toast" role="alert" aria-live="assertive" aria-atomic="true"></div>

<script>
(() => {
  "use strict";

  // --- Variables y estados ---
  let chart, candleSeries, thresholdMinLine, thresholdMaxLine;
  let coinListData = [];
  let selectedSymbol = null;
  let thresholds = { minPercent: -2, maxPercent: 2 };
  let alertConfig = { realtime: true, email: false };
  let ws = null;
  let basePriceAtSelection = null; // precio cuando se seleccionó moneda para calcular umbrales
  let reconnectTimeout = null;
  const LOCALSTORAGE_KEYS = {
    symbol: 'trading_alarm_selectedSymbol',
    thresholds: 'trading_alarm_thresholds',
    alertConfig: 'trading_alarm_alertConfig',
  };

  const popupContainer = document.getElementById('popup-container');
  const alertToast = document.getElementById('alert-toast');
  const coinListElement = document.getElementById('coin-list');
  const tradingLive = document.getElementById('trading-live');

  // --- Funciones almacenamiento local ---
  function saveToStorage(key, value) {
    try {
      localStorage.setItem(key, JSON.stringify(value));
    } catch {
      showError("No se pudo guardar configuración en localStorage.");
    }
  }
  function loadFromStorage(key, defaultVal = null) {
    try {
      const val = localStorage.getItem(key);
      return val ? JSON.parse(val) : defaultVal;
    } catch {
      return defaultVal;
    }
  }

  // --- Función mostrar error ---
  function showError(msg) {
    alertToast.style.backgroundColor = '#e85656';
    alertToast.textContent = msg;
    alertToast.style.opacity = '1';
    setTimeout(() => alertToast.style.opacity = '0', 6000);
    console.error(msg);
  }
  // --- Función mostrar alerta ---
  function showAlert(msg) {
    alertToast.style.backgroundColor = '#4a9b4a';
    alertToast.textContent = msg;
    alertToast.style.opacity = '1';
    setTimeout(() => alertToast.style.opacity = '0', 4000);
  }

  // --- Helpers ---
  function formatPrice(num) {
    if (num === null || isNaN(num)) return '-';
    if (num >= 1) return num.toFixed(2);
    if (num >= 0.01) return num.toFixed(4);
    return num.toFixed(8);
  }
  function formatChangePercent(num) {
    if (num === null || isNaN(num)) return '-';
    const prefix = num > 0 ? '+' : '';
    return prefix + num.toFixed(2) + '%';
  }

  // --- API Binance funciones ---
  // Obtenemos listado monedas populares (limitémonos a monedas USDT de volumen alto)
  async function fetchCoinList() {
    try {
      const resp = await fetch('https://api.binance.com/api/v3/ticker/24hr');
      if (!resp.ok) throw new Error(`Binance API error: ${resp.status}`);
      const data = await resp.json();
      // Filtramos pares con USDT, tomamos top 30 volumen
      let filtered = data.filter(c => c.symbol.endsWith('USDT'));
      filtered.sort((a,b) => parseFloat(b.quoteVolume) - parseFloat(a.quoteVolume));
      return filtered.slice(0,30);
    } catch(e) {
      throw e;
    }
  }

  // Obtenemos velas (candlesticks) para gráfico
  async function fetchKlines(symbol, interval = '1m', limit = 100) {
    try {
      const url = `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`;
      const resp = await fetch(url);
      if (!resp.ok) throw new Error(`Binance API error: ${resp.status}`);
      const klines = await resp.json();
      // Formateamos para lightweightcharts
      return klines.map(k => ({
        time: Math.floor(k[0]/1000),
        open: parseFloat(k[1]),
        high: parseFloat(k[2]),
        low: parseFloat(k[3]),
        close: parseFloat(k[4]),
        volume: parseFloat(k[5]),
      }));
    } catch(e) {
      throw e;
    }
  }

  // --- Render listado monedas en sidebar ---
  function renderCoinList() {
    coinListElement.innerHTML = '';
    if (!coinListData.length) {
      coinListElement.innerHTML = '<li>No hay datos disponibles</li>';
      return;
    }
    for (const coin of coinListData) {
      const li = document.createElement('li');
      li.setAttribute('role', 'option');
      li.setAttribute('tabindex', '-1');
      li.className = coin.symbol === selectedSymbol ? 'selected' : '';
      li.dataset.symbol = coin.symbol;

      // Mostrar: símbolo + precio + cambio 24h estilo Binance
      const symbolSpan = document.createElement('span');
      symbolSpan.textContent = coin.symbol.replace('USDT','');
      symbolSpan.className = 'coin-symbol';

      const priceSpan = document.createElement('span');
      priceSpan.textContent = formatPrice(parseFloat(coin.lastPrice));
      priceSpan.className = 'coin-price';

      const change = parseFloat(coin.priceChangePercent);
      const changeSpan = document.createElement('span');
      changeSpan.textContent = formatChangePercent(change);
      changeSpan.className = 'coin-change ' + (change >= 0 ? 'change-positive' : 'change-negative');

      li.appendChild(symbolSpan);
      li.appendChild(priceSpan);
      li.appendChild(changeSpan);

      // Click para seleccionar moneda (solo 1)
      li.addEventListener('click', () => {
        if (selectedSymbol === coin.symbol) return; // ya seleccionado
        selectedSymbol = coin.symbol;
        saveToStorage(LOCALSTORAGE_KEYS.symbol, selectedSymbol);
        basePriceAtSelection = parseFloat(coin.lastPrice);
        // Refrescar UI y gráfico
        renderCoinList();
        loadChartForSymbol(selectedSymbol);
        closePopup();
      });

      coinListElement.appendChild(li);
    }
  }

  // --- Popup manejo ---
  function openPopup(title, bodyContent) {
    popupContainer.setAttribute('aria-hidden', 'false');
    popupContainer.innerHTML = `
      <div class="popup" role="document">
        <header class="popup-header">
          <div id="popup-title">${title}</div>
          <button class="popup-close" aria-label="Cerrar popup" title="Cerrar popup">&times;</button>
        </header>
        <div class="popup-body">${bodyContent}</div>
      </div>`;
    popupContainer.querySelector('.popup-close').onclick = closePopup;
  }
  function closePopup() {
    popupContainer.setAttribute('aria-hidden', 'true');
    popupContainer.innerHTML = '';
  }

  // --- Popup Criptomonedas ---
  function openCryptoPopup() {
    if (!coinListData.length) {
      showError("Lista de monedas no cargada aún.");
      return;
    }
    // Construir body con lista monedas para seleccionar
    let body = `<p>Seleccione una sola moneda (solo 1):</p><ul style="max-height:300px; overflow-y:auto; list-style:none; padding:0; margin:0;">`;
    for (const coin of coinListData) {
      body += `
      <li style="padding:0.3rem; cursor:pointer; user-select:none; border-radius:4px;" data-symbol="${coin.symbol}">
        ${coin.symbol.replace('USDT','')} - Precio: ${formatPrice(parseFloat(coin.lastPrice))} USDT - Cambio 24h: <span style="color:${parseFloat(coin.priceChangePercent) >= 0 ? '#4caf50' : '#e85656'};">${formatChangePercent(parseFloat(coin.priceChangePercent))}</span>
      </li>`;
    }
    body += `</ul>`;
    body += `<div class="btn-group">
      <button id="crypto-popup-close-btn">Cerrar sin guardar</button>
    </div>`;
    openPopup('Seleccionar Criptomoneda', body);

    const listItems = popupContainer.querySelectorAll('li[data-symbol]');
    listItems.forEach(li => {
      li.addEventListener('click', () => {
        const sym = li.getAttribute('data-symbol');
        selectedSymbol = sym;
        saveToStorage(LOCALSTORAGE_KEYS.symbol, selectedSymbol);
        const coin = coinListData.find(c => c.symbol === sym);
        basePriceAtSelection = parseFloat(coin.lastPrice);
        renderCoinList();
        loadChartForSymbol(selectedSymbol);
        closePopup();
      });
    });

    document.getElementById('crypto-popup-close-btn').onclick = () => closePopup();
  }

  // --- Popup Umbrales ---
  function openThresholdPopup() {
    const body = `
    <form id="threshold-form">
      <label for="min-threshold">Umbral mínimo (%)</label>
      <input type="number" id="min-threshold" name="min-threshold" step="0.1" min="-100" max="0" value="${thresholds.minPercent}">
      <br>
      <label for="max-threshold">Umbral máximo (%)</label>
      <input type="number" id="max-threshold" name="max-threshold" step="0.1" min="0" max="100" value="${thresholds.maxPercent}">
      <br>
      <div class="btn-group">
        <button type="submit">Guardar</button>
        <button type="button" id="threshold-popup-close-btn">Cerrar sin guardar</button>
      </div>
    </form>
    `;
    openPopup('Configurar Umbrales', body);

    const form = document.getElementById('threshold-form');
    form.addEventListener('submit', e => {
      e.preventDefault();
      const minV = parseFloat(form['min-threshold'].value);
      const maxV = parseFloat(form['max-threshold'].value);
      if (isNaN(minV) || isNaN(maxV) || minV >= 0 || maxV <= 0) {
        showError('Los umbrales deben ser porcentajes: mínimo < 0 y máximo > 0');
        return;
      }
      thresholds.minPercent = minV;
      thresholds.maxPercent = maxV;
      saveToStorage(LOCALSTORAGE_KEYS.thresholds, thresholds);
      drawThresholdLines();
      closePopup();
    });

    document.getElementById('threshold-popup-close-btn').onclick = () => closePopup();
  }

  // --- Popup Alertas ---
  function openAlertPopup() {
    const body = `
    <form id="alert-form">
      <fieldset>
        <legend>Alertas en tiempo real</legend>
        <label><input type="radio" name="realtime-alert" value="yes" ${alertConfig.realtime ? 'checked' : ''}> Sí</label>
        <label><input type="radio" name="realtime-alert" value="no" ${!alertConfig.realtime ? 'checked' : ''}> No</label>
      </fieldset>
      <fieldset>
        <legend>Alertas por email</legend>
        <label><input type="radio" name="email-alert" value="yes" ${alertConfig.email ? 'checked' : ''}> Sí</label>
        <label><input type="radio" name="email-alert" value="no" ${!alertConfig.email ? 'checked' : ''}> No</label>
      </fieldset>
      <div class="btn-group">
        <button type="submit">Guardar</button>
        <button type="button" id="alert-popup-close-btn">Cerrar sin guardar</button>
      </div>
    </form>
    `;
    openPopup('Configurar Alertas', body);

    const form = document.getElementById('alert-form');
    form.addEventListener('submit', e => {
      e.preventDefault();
      alertConfig.realtime = form['realtime-alert'].value === 'yes';
      alertConfig.email = form['email-alert'].value === 'yes';
      saveToStorage(LOCALSTORAGE_KEYS.alertConfig, alertConfig);
      closePopup();
    });

    document.getElementById('alert-popup-close-btn').onclick = () => closePopup();
  }

  // --- Configuración inicial ---
  async function initialize() {
    try {
      coinListData = await fetchCoinList();
    } catch (e) {
      showError('Error al cargar lista de monedas: ' + e.message);
      // Reintento en 10s
      setTimeout(initialize, 10000);
      return;
    }

    renderCoinList();

    // Cargar configuración guardada
    selectedSymbol = loadFromStorage(LOCALSTORAGE_KEYS.symbol, 'BTCUSDT');
    thresholds = loadFromStorage(LOCALSTORAGE_KEYS.thresholds, { minPercent: -2, maxPercent: 2 });
    alertConfig = loadFromStorage(LOCALSTORAGE_KEYS.alertConfig, { realtime: true, email: false });

    basePriceAtSelection = coinListData.find(c => c.symbol === selectedSymbol)?.lastPrice || null;
    if (!basePriceAtSelection) {
      basePriceAtSelection = 0;
    }

    renderCoinList();
    loadChartForSymbol(selectedSymbol);
  }

  // --- Crear gráfico ---
  async function loadChartForSymbol(symbol) {
    // Limpiar websocket si existe
    if (ws) {
      ws.close();
      ws = null;
    }
    tradingLive.innerHTML = '';
    basePriceAtSelection = null;
    const coinData = coinListData.find(c => c.symbol === symbol);
    if (!coinData) {
      showError('Moneda no encontrada: ' + symbol);
      return;
    }
    basePriceAtSelection = parseFloat(coinData.lastPrice);

    chart = LightweightCharts.createChart(tradingLive, {
      width: tradingLive.clientWidth,
      height: tradingLive.clientHeight,
      layout: {
        backgroundColor: '#131722',
        textColor: '#d1d4dc',
      },
      grid: {
        vertLines: {
          color: '#2b2e43',
        },
        horzLines: {
          color: '#2b2e43',
        },
      },
      crosshair: {
        mode: LightweightCharts.CrosshairMode.Normal,
      },
      rightPriceScale: {
        borderColor: '#555',
      },
      timeScale: {
        borderColor: '#555',
        timeVisible: true,
        secondsVisible: false,
      },
    });

    candleSeries = chart.addCandlestickSeries();

    try {
      const klines = await fetchKlines(symbol, '1m', 100);
      candleSeries.setData(klines);
    } catch (e) {
      showError('Error al cargar datos de velas: ' + e.message);
    }

    drawThresholdLines();

    // Websocket streaming datos
    startWebSocket(symbol);

    // Resizing
    window.addEventListener('resize', () => {
      chart.applyOptions({ width: tradingLive.clientWidth, height: tradingLive.clientHeight });
    });
  }

  // --- Dibuja líneas umbrales ---
  function drawThresholdLines() {
    if (!chart || !candleSeries || !basePriceAtSelection) return;
    // Eliminar líneas previas
    if (thresholdMinLine) candleSeries.removePriceLine(thresholdMinLine);
    if (thresholdMaxLine) candleSeries.removePriceLine(thresholdMaxLine);

    const minValue = basePriceAtSelection * (1 + thresholds.minPercent / 100);
    const maxValue = basePriceAtSelection * (1 + thresholds.maxPercent / 100);

    thresholdMinLine = candleSeries.createPriceLine({
      price: minValue,
      color: '#e85656',
      lineWidth: 2,
      lineStyle: LightweightCharts.LineStyle.Dashed,
      axisLabelVisible: true,
      title: `Umbral Mín: ${minValue.toFixed(4)}`,
    });

    thresholdMaxLine = candleSeries.createPriceLine({
      price: maxValue,
      color: '#4caf50',
      lineWidth: 2,
      lineStyle: LightweightCharts.LineStyle.Dashed,
      axisLabelVisible: true,
      title: `Umbral Máx: ${maxValue.toFixed(4)}`,
    });
  }

  // --- WebSocket datos en tiempo real ---
  function startWebSocket(symbol) {
    if (ws) {
      ws.close();
      ws = null;
    }
    const lowerSymbol = symbol.toLowerCase();
    const url = `wss://stream.binance.com:9443/ws/${lowerSymbol}@kline_1m`;
    try {
      ws = new WebSocket(url);
      ws.onopen = () => {
        showAlert(`Conectado a datos en tiempo real: ${symbol}`);
      };
      ws.onclose = () => {
        showAlert(`Conexión cerrada. Reintentando en 5s...`);
        reconnectTimeout = setTimeout(() => startWebSocket(symbol), 5000);
      };
      ws.onerror = (e) => {
        showError('Error WebSocket: ' + e.message);
        ws.close();
      };
      ws.onmessage = event => {
        try {
          const msg = JSON.parse(event.data);
          if (msg.k && msg.k.x) { // vela cerrada
            candleSeries.update({
              time: Math.floor(msg.k.t / 1000),
              open: parseFloat(msg.k.o),
              high: parseFloat(msg.k.h),
              low: parseFloat(msg.k.l),
              close: parseFloat(msg.k.c),
              volume: parseFloat(msg.k.v),
            });
            checkThresholdAlert(parseFloat(msg.k.c));
          }
        } catch {
          // Ignorar errores parseo
        }
      };
    } catch (e) {
      showError('Fallo al iniciar WebSocket: ' + e.message);
      setTimeout(() => startWebSocket(symbol), 5000);
    }
  }

  // --- Comprobar alertas ---
  function checkThresholdAlert(currentPrice) {
    if (!alertConfig.realtime) return;
    if (!basePriceAtSelection) return;
    const minValue = basePriceAtSelection * (1 + thresholds.minPercent / 100);
    const maxValue = basePriceAtSelection * (1 + thresholds.maxPercent / 100);
    if (currentPrice <= minValue) {
      showAlert(`Alerta: Precio ${selectedSymbol} ha caído por debajo del umbral mínimo (${minValue.toFixed(4)})`);
    } else if (currentPrice >= maxValue) {
      showAlert(`Alerta: Precio ${selectedSymbol} ha superado el umbral máximo (${maxValue.toFixed(4)})`);
    }
  }

  // --- Eventos botones ---
  document.getElementById('btn-crypto').addEventListener('click', () => {
    openCryptoPopup();
  });
  document.getElementById('btn-threshold').addEventListener('click', () => {
    openThresholdPopup();
  });
  document.getElementById('btn-alert').addEventListener('click', () => {
    openAlertPopup();
  });

  // --- Inicio ---
  initialize();

})();
</script>
</body>
</html>

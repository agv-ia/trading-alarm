<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trading Alarm con WebSocket - Umbral Estático</title>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: Arial, sans-serif;
      background-color: #0e111a; color: #fff;
      display: flex; flex-direction: column; height: 100vh;
    }
    header {
      text-align: center;
      padding: 1rem;
      background-color: #1e222d;
      font-size: 1.5rem;
      font-weight: bold;
    }
    .container {
      display: flex; flex: 1; overflow: hidden;
    }
    .sidebar {
      width: 20%;
      background-color: #1e222d;
      padding: 1rem;
    }
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .live-chart {
      height: calc(100% - 80px);
      overflow: hidden;
      position: relative;
    }
    #chart {
      width: 100%;
      height: 100%;
    }
    .config {
      height: 80px;
      background-color: #1e222d;
      display: flex;
      align-items: center;
      padding: 0.5rem;
      flex-wrap: wrap;
      border-top: 1px solid #333;
      z-index: 10;
    }
    .config button, .config select {
      margin-right: 10px;
      padding: 0.5rem 1rem;
      background-color: #2c2f36;
      color: #fff;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .info-box {
      background-color: #2c2f36;
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1rem;
    }
    .info-box p {
      margin: 0.5rem 0;
    }
    .info-box span {
      font-weight: bold;
    }
    .alert-high { color: #ff4560; }
    .alert-low { color: #00e396; }
    .alert-safe { color: #ffffff; }
    audio { display: none; }
  </style>
</head>
<body>
  <header>Trading Alarm con WebSocket - Umbral Estático</header>
  <div class="container">
    <div class="sidebar">
      <h3>Trading Data</h3>
      <div class="info-box">
        <p>Moneda: <span id="info-symbol">BTC</span></p>
        <p>Precio base: <span id="info-base-price">-</span></p>
        <p>Precio actual: <span id="info-price" class="alert-safe">-</span></p>
        <p>Umbral superior: <span id="info-upper">+2%</span></p>
        <p>Umbral inferior: <span id="info-lower">-2%</span></p>
        <p>Tipo de alerta: <span id="info-alert">Pantalla y sonido</span></p>
      </div>
    </div>
    <div class="main">
      <div class="live-chart">
        <div id="chart"></div>
      </div>
      <div class="config">
        <select id="symbol-select">
          <option value="BTCUSDT">BTC/USDT</option>
          <option value="ETHUSDT">ETH/USDT</option>
          <option value="BNBUSDT">BNB/USDT</option>
          <option value="ADAUSDT">ADA/USDT</option>
        </select>
        <button onclick="setThresholds()">Umbrales</button>
        <button onclick="toggleAlerts()">Alertas</button>
        <select id="timeframe-select">
          <option value="1m">1m</option>
          <option value="5m">5m</option>
          <option value="15m">15m</option>
          <option value="1h">1h</option>
          <option value="4h">4h</option>
          <option value="1d">1d</option>
        </select>
      </div>
    </div>
  </div>
  <audio id="alert-sound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

  <script>
    let chart;
    let candles = [];
    let ws = null;

    let currentSymbol = 'BTCUSDT';
    let timeframe = '1m';

    // Precio base estático para los umbrales, fijado al inicio o al cambiar símbolo
    let basePrice = null;

    // Umbrales en porcentaje (%)
    let upperThreshold = 2;
    let lowerThreshold = -2;
    let alertsEnabled = true;

    const priceEl = document.getElementById('info-price');
    const basePriceEl = document.getElementById('info-base-price');
    const symbolEl = document.getElementById('info-symbol');
    const upperEl = document.getElementById('info-upper');
    const lowerEl = document.getElementById('info-lower');
    const alertEl = document.getElementById('info-alert');
    const symbolSelect = document.getElementById('symbol-select');
    const timeframeSelect = document.getElementById('timeframe-select');

    function updateInfoPanel(currentPrice = null) {
      symbolEl.textContent = currentSymbol.replace('USDT', '');
      upperEl.textContent = `+${upperThreshold}%`;
      lowerEl.textContent = `${lowerThreshold}%`;
      alertEl.textContent = alertsEnabled ? 'Pantalla y sonido' : 'Desactivadas';
      basePriceEl.textContent = basePrice ? `$${basePrice.toFixed(2)}` : '-';

      if (currentPrice !== null) {
        const pct = ((currentPrice - basePrice) / basePrice) * 100;
        let cls = 'alert-safe';
        if (pct >= upperThreshold) cls = 'alert-high';
        else if (pct <= lowerThreshold) cls = 'alert-low';
        priceEl.className = cls;
        priceEl.textContent = `$${currentPrice.toFixed(2)}`;
      } else {
        priceEl.textContent = '-';
      }
    }

    // Solicita permisos notificaciones
    if ("Notification" in window && Notification.permission !== "granted") {
      Notification.requestPermission();
    }

    async function fetchCandles(symbol, interval) {
      try {
        const res = await fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=150`);
        const data = await res.json();
        return data.map(d => ({
          x: new Date(d[0]),
          y: [parseFloat(d[1]), parseFloat(d[2]), parseFloat(d[3]), parseFloat(d[4])]
        }));
      } catch (err) {
        console.error('Error al obtener velas:', err);
        return [];
      }
    }

    // Dibuja las líneas horizontales fijas según basePrice + umbrales %
    function getAnnotations() {
      if (!basePrice) return [];
      return [
        {
          y: basePrice * (1 + upperThreshold / 100),
          borderColor: '#FF4560',
          label: {
            borderColor: '#FF4560',
            style: { color: '#fff', background: '#FF4560' },
            text: `Umbral Superior (${upperThreshold}%)`
          }
        },
        {
          y: basePrice * (1 + lowerThreshold / 100),
          borderColor: '#00E396',
          label: {
            borderColor: '#00E396',
            style: { color: '#000', background: '#00E396' },
            text: `Umbral Inferior (${lowerThreshold}%)`
          }
        }
      ];
    }

    async function initChart() {
      candles = await fetchCandles(currentSymbol, timeframe);
      if (!candles.length) return;

      // Fijar precio base al cierre de la última vela
      basePrice = candles[candles.length -1].y[3];

      const options = {
        chart: {
          type: 'candlestick',
          height: '100%',
          animations: { enabled: true },
          toolbar: { autoSelected: 'pan', show: true },
        },
        series: [{ data: candles }],
        xaxis: { type: 'datetime' },
        theme: { mode: 'dark' },
        annotations: { yaxis: getAnnotations() }
      };

      if (chart) chart.destroy();
      chart = new ApexCharts(document.querySelector("#chart"), options);
      chart.render();

      updateInfoPanel(basePrice);
    }

    // Procesa los datos recibidos del websocket y actualiza gráfico y precio actual
    function processWsCandle(candleData) {
      const candle = {
        x: new Date(candleData.t),
        y: [
          parseFloat(candleData.o),
          parseFloat(candleData.h),
          parseFloat(candleData.l),
          parseFloat(candleData.c)
        ]
      };

      // Actualiza la última vela si es la misma
      if (candles.length && candles[candles.length -1].x.getTime() === candle.x.getTime()) {
        candles[candles.length -1] = candle;
      } else {
        candles.push(candle);
        if (candles.length > 150) candles.shift();
      }

      updateChart();
      updateInfoPanel(candle.y[3]);
      checkThreshold(candle.y[3]);
    }

    function updateChart() {
      chart.updateSeries([{ data: candles }]);
      chart.updateOptions({
        annotations: { yaxis: getAnnotations() }
      });
    }

    function checkThreshold(price) {
      if (!alertsEnabled || !basePrice) return;
      const pct = ((price - basePrice) / basePrice) * 100;
      if (pct >= upperThreshold) {
        showNotification(`Precio superó umbral superior: +${pct.toFixed(2)}%`);
        document.getElementById('alert-sound').play();
      } else if (pct <= lowerThreshold) {
        showNotification(`Precio cayó por debajo del umbral inferior: ${pct.toFixed(2)}%`);
        document.getElementById('alert-sound').play();
      }
    }

    function showNotification(msg) {
      if (Notification.permission === 'granted') {
        new Notification("Trading Alarm", { body: msg });
      }
    }

    function openWebSocket() {
      if (ws) {
        ws.close();
        ws = null;
      }
      const endpoint = `wss://stream.binance.com:9443/ws/${currentSymbol.toLowerCase()}@kline_${timeframe}`;
      ws = new WebSocket(endpoint);

      ws.onopen = () => {
        console.log('WebSocket conectado:', endpoint);
      };

      ws.onmessage = event => {
        const msg = JSON.parse(event.data);
        if (msg.e === 'kline') {
          processWsCandle(msg.k);
        }
      };

      ws.onclose = () => {
        console.log('WebSocket cerrado, reconectando en 3s...');
        setTimeout(openWebSocket, 3000);
      };

      ws.onerror = err => {
        console.error('WebSocket error:', err);
        ws.close();
      };
    }

    async function changeSymbol(newSymbol) {
      currentSymbol = newSymbol;
      updateInfoPanel(null);
      await initChart();
      openWebSocket();
    }

    async function changeTimeframe(newTimeframe) {
      timeframe = newTimeframe;
      updateInfoPanel(null);
      await initChart();
      openWebSocket();
    }

    function setThresholds() {
      const upper = prompt("Introduce umbral superior (%)", upperThreshold);
      const lower = prompt("Introduce umbral inferior (%)", lowerThreshold);
      if (!isNaN(upper)) upperThreshold = parseFloat(upper);
      if (!isNaN(lower)) lowerThreshold = parseFloat(lower);
      updateInfoPanel();
      updateChart();
    }

    function toggleAlerts() {
      alertsEnabled = !alertsEnabled;
      updateInfoPanel();
    }

    symbolSelect.addEventListener('change', e => changeSymbol(e.target.value));
    timeframeSelect.addEventListener('change', e => changeTimeframe(e.target.value));

    (async function() {
      updateInfoPanel(null);
      await initChart();
      openWebSocket();
    })();
  </script>
</body>
</html>

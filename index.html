<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta http-equiv="Content-Security-Policy"
  content="
    default-src 'self';
    script-src 'self' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com;
    connect-src https://api.binance.com;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    font-src https://fonts.gstatic.com;
    img-src * data:;
    media-src 'self' https://www.soundjay.com;
  ">
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Trading Alarm</title>

<!-- Quitar integrity para evitar error -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@3.3.0/dist/chartjs-chart-financial.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet" />

<style>
  /* El mismo CSS que ya tienes */
  /* ... */
</style>
</head>
<body>
<header>Trading Alarm</header>
<div class="container">
  <div class="sidebar">
    <h3>Trading Data</h3>
  </div>
  <div class="main">
    <div class="live">
      <canvas id="candlestickChart"></canvas>
    </div>
    <div class="config">
      <button id="btnCrypto">Criptomonedas</button>
      <button id="btnThreshold">Umbrales</button>
      <button id="btnAlerts">Alertas</button>
    </div>
  </div>
</div>
<div id="popup-container"></div>
<audio id="beep" src="https://www.soundjay.com/buttons/sounds/beep-07.mp3" preload="auto"></audio>

<script>
  // Mover aquí todos los listeners para evitar inline
  document.getElementById('btnCrypto').addEventListener('click', openCryptoPopup);
  document.getElementById('btnThreshold').addEventListener('click', openThresholdPopup);
  document.getElementById('btnAlerts').addEventListener('click', openAlertsPopup);

  // Todo el JS que ya tenías, sin cambios en lógica, excepto el notifyUser que puse antes.

  window.addEventListener('error', function(e) {
    console.error('Global Error:', e);
  });

  let chart;
  let selectedSymbol = localStorage.getItem('symbol') || 'BTCUSDT';
  let upperThreshold = parseFloat(localStorage.getItem('upperThreshold')) || 2;
  let lowerThreshold = parseFloat(localStorage.getItem('lowerThreshold')) || -2;
  let email = localStorage.getItem('email') || '';
  let alerts = {
    screen: true,
    email: false
  };

  function openCryptoPopup() {
    const popup = document.createElement('div');
    popup.className = 'popup';
    popup.innerHTML = `<span class="close" id="closePopup">×</span>
      <h3>Selecciona una criptomoneda</h3>
      <p>(Solo puedes seleccionar 1)</p>
      <div id="crypto-list">Cargando monedas populares...</div>`;
    document.getElementById('popup-container').appendChild(popup);

    document.getElementById('closePopup').addEventListener('click', () => popup.remove());
    fetchCryptoList();
  }

  async function fetchCryptoList() {
    try {
      const res = await axios.get('https://api.binance.com/api/v3/ticker/24hr');
      const popular = ['BTCUSDT', 'ETHUSDT', 'BNBUSDT', 'ADAUSDT', 'SOLUSDT', 'XRPUSDT'];
      const filtered = res.data.filter(item => popular.includes(item.symbol));
      const list = filtered.map(item => `
        <div class='crypto-item' data-symbol='${item.symbol}'>
          ${item.symbol} - ${parseFloat(item.lastPrice).toFixed(2)} USDC (${parseFloat(item.priceChangePercent).toFixed(2)}%)
        </div>`).join('');
      document.getElementById('crypto-list').innerHTML = list;

      document.querySelectorAll('.crypto-item').forEach(el =>
        el.addEventListener('click', () => selectSymbol(el.getAttribute('data-symbol')))
      );
    } catch (err) {
      document.getElementById('crypto-list').innerHTML = 'Error al cargar. Reintentando...';
      setTimeout(fetchCryptoList, 3000);
    }
  }

  function selectSymbol(symbol) {
    selectedSymbol = symbol;
    localStorage.setItem('symbol', symbol);
    document.querySelectorAll('.popup').forEach(p => p.remove());
    initChart();
  }

  function openThresholdPopup() {
    const popup = document.createElement('div');
    popup.className = 'popup';
    popup.innerHTML = `<span class="close" id="closePopup">×</span>
      <h3>Configura Umbrales</h3>
      <label>Umbral Inferior (%): <input type='number' id='low' value='${lowerThreshold}'/></label><br/>
      <label>Umbral Superior (%): <input type='number' id='high' value='${upperThreshold}'/></label><br/><br/>
      <button id="saveThresholdsBtn">Guardar</button>
      <button id="closeBtn">Cerrar</button>`;
    document.getElementById('popup-container').appendChild(popup);

    document.getElementById('closePopup').addEventListener('click', () => popup.remove());
    document.getElementById('closeBtn').addEventListener('click', () => popup.remove());
    document.getElementById('saveThresholdsBtn').addEventListener('click', saveThresholds);
  }

  function saveThresholds() {
    lowerThreshold = parseFloat(document.getElementById('low').value);
    upperThreshold = parseFloat(document.getElementById('high').value);
    localStorage.setItem('lowerThreshold', lowerThreshold);
    localStorage.setItem('upperThreshold', upperThreshold);
    document.querySelectorAll('.popup').forEach(p => p.remove());
  }

  function openAlertsPopup() {
    const popup = document.createElement('div');
    popup.className = 'popup';
    popup.innerHTML = `<span class="close" id="closePopup">×</span>
      <h3>Alertas</h3>
      <label><input type='checkbox' id='alert-screen' ${alerts.screen ? 'checked' : ''}/> Notificación en pantalla</label><br/>
      <label><input type='checkbox' id='alert-email' ${alerts.email ? 'checked' : ''}/> Alerta por Email</label><br/>
      <div id="email-config" style="display: ${alerts.email ? 'block' : 'none'}">
        <input type="email" id="email-input" value="${email}" placeholder="Introduce tu email" />
        <button id="sendTestBtn">Enviar Test</button>
      </div>
      <br/>
      <button id="saveAlertsBtn">Guardar</button>
      <button id="closeBtn">Cerrar</button>`;
    document.getElementById('popup-container').appendChild(popup);

    document.getElementById('closePopup').addEventListener('click', () => popup.remove());
    document.getElementById('closeBtn').addEventListener('click', () => popup.remove());

    document.getElementById('alert-email').addEventListener('change', e => {
      document.getElementById('email-config').style.display = e.target.checked ? 'block' : 'none';
    });

    document.getElementById('sendTestBtn').addEventListener('click', sendTestEmail);
    document.getElementById('saveAlertsBtn').addEventListener('click', saveAlerts);
  }

  function saveAlerts() {
    alerts.screen = document.getElementById('alert-screen').checked;
    alerts.email = document.getElementById('alert-email').checked;
    email = document.getElementById('email-input').value;
    localStorage.setItem('email', email);
    document.querySelectorAll('.popup').forEach(p => p.remove());
  }

  function sendTestEmail() {
    alert(`Simulación: enviando test a ${email}`);
  }

  function notifyUser(message) {
    if (!alerts.screen) return;

    if (Notification.permission === 'granted') {
      new Notification('Trading Alarm', { body: message });
      document.getElementById('beep').play();
    } else if (Notification.permission !== 'denied') {
      Notification.requestPermission().then(permission => {
        if (permission === 'granted') {
          new Notification('Trading Alarm', { body: message });
          document.getElementById('beep').play();
        } else {
          console.log('Notificación no permitida por el usuario');
        }
      });
    } else {
      console.log('Notificaciones bloqueadas por el usuario');
    }
  }

  async function fetchChartData() {
    try {
      const res = await axios.get(`https://api.binance.com/api/v3/klines?symbol=${selectedSymbol}&interval=1m&limit=100`);
      const candles = res.data.map(d => ({
        x: new Date(d[0]),
        o: parseFloat(d[1]),
        h: parseFloat(d[2]),
        l: parseFloat(d[3]),
        c: parseFloat(d[4])
      }));
      updateChart(candles);
      checkThreshold(candles[candles.length - 1].c);
    } catch (err) {
      console.error("Error al conectar a Binance", err);
      setTimeout(fetchChartData, 5000);
    }
  }

  function checkThreshold(price) {
    const base = price / (1 + upperThreshold / 100);
    const upper = base * (1 + upperThreshold / 100);
    const lower = base * (1 + lowerThreshold / 100);

    if (price >= upper || price <= lower) {
      notifyUser(`Umbral alcanzado en ${selectedSymbol}: ${price} USDC`);
    }
  }

  function initChart() {
    if (chart) chart.destroy();
    const ctx = document.getElementById('candlestickChart').getContext('2d');
    chart = new Chart(ctx, {
      type: 'candlestick',
      data: { datasets: [{ label: selectedSymbol, data: [] }] },
      options: {
        responsive: true,
        plugins: { legend: { labels: { color: '#fff' } } },
        scales: {
          x: { ticks: { color: '#aaa' } },
          y: { ticks: { color: '#aaa' } }
        }
      }
    });
    fetchChartData();
    setInterval(fetchChartData, 60000);
  }

  function updateChart(data) {
    chart.data.datasets[0].data = data;
    chart.update();
  }

  initChart();
</script>
</body>
</html>

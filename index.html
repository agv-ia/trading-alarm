<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta http-equiv="Content-Security-Policy" content="
  default-src 'self'; 
  script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; 
  style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; 
  font-src https://fonts.gstatic.com; 
  img-src * data:;
  media-src 'self' https://www.soundjay.com;
">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Trading Alarm 2</title>

<!-- Librerías sin integrity para evitar bloqueo -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@3.3.0/dist/chartjs-chart-financial.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet" />

<style>
  * {
    box-sizing: border-box;
    font-family: 'Inter', sans-serif;
  }
  body {
    margin: 0;
    background-color: #1e1e1e;
    color: #fff;
    overflow: hidden;
  }
  header {
    text-align: center;
    font-size: 1.5rem;
    font-weight: bold;
    padding: 1rem;
    background-color: #121212;
    border-bottom: 1px solid #333;
  }
  .container {
    display: flex;
    height: calc(100vh - 64px);
    flex-direction: row;
  }
  .sidebar {
    width: 20%;
    background-color: #181818;
    padding: 1rem;
    border-right: 1px solid #333;
  }
  .main {
    width: 80%;
    display: flex;
    flex-direction: column;
  }
  .live {
    flex: 1;
    background-color: #1e1e1e;
    padding: 1rem;
    position: relative;
  }
  .config {
    height: 12.5%;
    background-color: #121212;
    display: flex;
    align-items: flex-start;
    padding: 0.5rem;
    gap: 0.5rem;
    border-top: 1px solid #333;
  }
  button {
    background-color: #333;
    color: #fff;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
  }
  button:hover {
    background-color: #444;
  }
  .popup {
    position: fixed;
    top: 20%;
    left: 50%;
    transform: translate(-50%, -20%);
    background: #222;
    padding: 1rem;
    border: 1px solid #555;
    border-radius: 8px;
    z-index: 1000;
    max-height: 70vh;
    overflow-y: auto;
  }
  .popup h3 {
    margin-top: 0;
  }
  .popup .close {
    float: right;
    cursor: pointer;
    color: red;
  }
  .crypto-item {
    display: flex;
    justify-content: space-between;
    padding: 0.3rem 0;
    border-bottom: 1px solid #333;
    cursor: pointer;
  }
  .crypto-item:hover {
    background-color: #333;
  }
  .threshold-line {
    position: absolute;
    width: 100%;
    height: 1px;
    background: red;
  }
  .threshold-label {
    position: absolute;
    font-size: 0.7rem;
    color: red;
  }
  .notification {
    position: fixed;
    top: 1rem;
    right: 1rem;
    background: #333;
    padding: 1rem;
    border-radius: 6px;
    box-shadow: 0 0 10px #000;
    z-index: 2000;
  }
</style>
</head>
<body>
<header>Trading Alarm</header>
<div class="container">
  <div class="sidebar">
    <h3>Trading Data</h3>
  </div>
  <div class="main">
    <div class="live">
      <canvas id="candlestickChart"></canvas>
    </div>
    <div class="config">
      <button onclick="openCryptoPopup()">Criptomonedas</button>
      <button onclick="openThresholdPopup()">Umbrales</button>
      <button onclick="openAlertsPopup()">Alertas</button>
    </div>
  </div>
</div>

<div id="popup-container"></div>

<audio id="beep" src="https://www.soundjay.com/buttons/sounds/beep-07.mp3" preload="auto"></audio>

<script>
  window.addEventListener('error', e => console.error('Global Error:', e));

  let chart;
  let selectedSymbol = localStorage.getItem('symbol') || 'BTCUSDT';
  let upperThreshold = parseFloat(localStorage.getItem('upperThreshold')) || 2;
  let lowerThreshold = parseFloat(localStorage.getItem('lowerThreshold')) || -2;
  let email = localStorage.getItem('email') || '';
  let alerts = { screen: true, email: false };

  function openCryptoPopup() {
    const popup = document.createElement('div');
    popup.className = 'popup';
    popup.innerHTML = `
      <span class="close" onclick="this.parentElement.remove()">×</span>
      <h3>Selecciona una criptomoneda</h3>
      <p>(Solo puedes seleccionar 1)</p>
      <div id="crypto-list">Cargando monedas populares...</div>
    `;
    document.getElementById('popup-container').appendChild(popup);
    fetchCryptoList();
  }

  async function fetchCryptoList() {
    try {
      const res = await axios.get('https://api.binance.com/api/v3/ticker/24hr');
      const popular = ['BTCUSDT', 'ETHUSDT', 'BNBUSDT', 'ADAUSDT', 'SOLUSDT', 'XRPUSDT'];
      const filtered = res.data.filter(item => popular.includes(item.symbol));
      const list = filtered.map(item => `
        <div class='crypto-item' onclick="selectSymbol('${item.symbol}')">
          ${item.symbol} - ${parseFloat(item.lastPrice).toFixed(2)} USDC (${parseFloat(item.priceChangePercent).toFixed(2)}%)
        </div>
      `).join('');
      document.getElementById('crypto-list').innerHTML = list;
    } catch {
      document.getElementById('crypto-list').innerHTML = 'Error al cargar. Reintentando...';
      setTimeout(fetchCryptoList, 3000);
    }
  }

  function selectSymbol(symbol) {
    selectedSymbol = symbol;
    localStorage.setItem('symbol', symbol);
    document.querySelectorAll('.popup').forEach(p => p.remove());
    initChart();
  }

  function openThresholdPopup() {
    const popup = document.createElement('div');
    popup.className = 'popup';
    popup.innerHTML = `
      <span class="close" onclick="this.parentElement.remove()">×</span>
      <h3>Configura Umbrales</h3>
      <label>Umbral Inferior (%): <input type='number' id='low' value='${lowerThreshold}'/></label><br/>
      <label>Umbral Superior (%): <input type='number' id='high' value='${upperThreshold}'/></label><br/><br/>
      <button onclick='saveThresholds()'>Guardar</button>
      <button onclick='this.parentElement.remove()'>Cerrar</button>
    `;
    document.getElementById('popup-container').appendChild(popup);
  }

  function saveThresholds() {
    lowerThreshold = parseFloat(document.getElementById('low').value);
    upperThreshold = parseFloat(document.getElementById('high').value);
    localStorage.setItem('lowerThreshold', lowerThreshold);
    localStorage.setItem('upperThreshold', upperThreshold);
    document.querySelectorAll('.popup').forEach(p => p.remove());
  }

  function openAlertsPopup() {
    const popup = document.createElement('div');
    popup.className = 'popup';
    popup.innerHTML = `
      <span class="close" onclick="this.parentElement.remove()">×</span>
      <h3>Alertas</h3>
      <label><input type='checkbox' id='alert-screen' ${alerts.screen ? 'checked' : ''}/> Notificación en pantalla</label><br/>
      <label><input type='checkbox' id='alert-email' ${alerts.email ? 'checked' : ''}/> Alerta por Email</label><br/>
      <div id="email-config" style="display: ${alerts.email ? 'block' : 'none'}">
        <input type="email" id="email" placeholder="Tu email" value="${email}"/>
        <button onclick="saveEmail()">Guardar Email</button>
      </div>
      <button onclick='saveAlerts()'>Guardar</button>
      <button onclick='this.parentElement.remove()'>Cerrar</button>
    `;
    document.getElementById('popup-container').appendChild(popup);

    document.getElementById('alert-email').addEventListener('change', e => {
      document.getElementById('email-config').style.display = e.target.checked ? 'block' : 'none';
    });
  }

  function saveEmail() {
    email = document.getElementById('email').value;
    localStorage.setItem('email', email);
    alert('Email guardado');
  }

  function saveAlerts() {
    alerts.screen = document.getElementById('alert-screen').checked;
    alerts.email = document.getElementById('alert-email').checked;
    localStorage.setItem('alerts-screen', alerts.screen);
    localStorage.setItem('alerts-email', alerts.email);
    document.querySelectorAll('.popup').forEach(p => p.remove());
  }

  async function fetchCandles() {
    try {
      const now = Date.now();
      const startTime = now - 15 * 60 * 1000; // Últimos 15 minutos
      const res = await axios.get(`https://api.binance.com/api/v3/klines?symbol=${selectedSymbol}&interval=1m&startTime=${startTime}&limit=15`);
      return res.data.map(c => ({
        x: new Date(c[0]),
        o: parseFloat(c[1]),
        h: parseFloat(c[2]),
        l: parseFloat(c[3]),
        c: parseFloat(c[4]),
      }));
    } catch {
      return [];
    }
  }

  async function updateChart() {
    const candles = await fetchCandles();
    if (!candles.length) return;
    const last = candles[candles.length - 1];
    if (!chart) {
      const ctx = document.getElementById('candlestickChart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'candlestick',
        data: {
          datasets: [{
            label: selectedSymbol,
            data: candles,
            color: {
              up: '#4caf50',
              down: '#f44336',
              unchanged: '#999',
            },
          }],
        },
        options: {
          responsive: true,
          animation: false,
          scales: {
            x: {
              time: {
                unit: 'minute',
                tooltipFormat: 'HH:mm',
              },
              ticks: {
                source: 'auto',
              },
            },
            y: {
              beginAtZero: false,
            },
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              enabled: true,
            },
          },
        },
      });
    } else {
      chart.data.datasets[0].data = candles;
      chart.options.plugins.title = {text: selectedSymbol};
      chart.update();
    }

    // Control de alertas (simple ejemplo: porcentaje cambio de último cierre)
    const firstPrice = candles[0].c;
    const lastPrice = last.c;
    const changePercent = ((lastPrice - firstPrice) / firstPrice) * 100;

    if (changePercent >= upperThreshold) {
      showNotification(`📈 ${selectedSymbol} subió +${changePercent.toFixed(2)}%`, true);
    } else if (changePercent <= lowerThreshold) {
      showNotification(`📉 ${selectedSymbol} bajó ${changePercent.toFixed(2)}%`, true);
    }
  }

  function showNotification(message, playSound = false) {
    if (!alerts.screen) return;
    const n = document.createElement('div');
    n.className = 'notification';
    n.textContent = message;
    document.body.appendChild(n);
    setTimeout(() => n.remove(), 5000);
    if (playSound) {
      const beep = document.getElementById('beep');
      beep.play();
    }
  }

  function initChart() {
    if (chart) {
      chart.destroy();
      chart = null;
    }
    updateChart();
  }

  setInterval(updateChart, 15000);

  window.onload = initChart;
</script>

</body>
</html>

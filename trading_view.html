<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trading Alarm</title>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #0e111a;
      color: #fff;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      text-align: center;
      padding: 1rem;
      background-color: #1e222d;
      font-size: 1.5rem;
      font-weight: bold;
    }
    .container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    .sidebar {
      width: 20%;
      background-color: #1e222d;
      padding: 1rem;
      box-sizing: border-box;
    }
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .live-chart {
      flex-grow: 1;
      overflow: hidden;
      position: relative;
    }
    #chart {
      width: 100%;
      height: 100%;
      max-height: calc(100vh - 160px); /* Reservar espacio para header y config */
    }
    .config {
      height: 60px;
      background-color: #1e222d;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      padding: 0.5rem;
      box-sizing: border-box;
      z-index: 10;
      border-top: 1px solid #333;
    }
    .config button, .config select {
      margin-right: 10px;
      padding: 0.5rem 1rem;
      background-color: #2c2f36;
      color: #fff;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #2c2f36;
      padding: 20px;
      border: 1px solid #444;
      z-index: 1000;
      color: white;
      max-height: 80vh;
      overflow-y: auto;
    }
    .popup h3 {
      margin-top: 0;
    }
    .overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      z-index: 999;
    }
    .hidden {
      display: none;
    }
    .crypto-option {
      padding: 5px;
      border-bottom: 1px solid #444;
      cursor: pointer;
    }
    .crypto-option:hover {
      background-color: #3a3f50;
    }
    #timeframe-select {
      background-color: #2c2f36;
      color: white;
      border: none;
    }
  </style>
</head>
<body>
  <header>Trading Alarm</header>
  <div class="container">
    <div class="sidebar">
      <h3>Trading Data</h3>
    </div>
    <div class="main">
      <div class="live-chart">
        <div id="chart"></div>
      </div>
      <div class="config">
        <button onclick="openCryptoPopup()">Criptomonedas</button>
        <button onclick="openThresholdPopup()">Umbrales</button>
        <button onclick="openAlertPopup()">Alertas</button>
        <select id="timeframe-select" onchange="changeTimeframe()">
          <option value="1m">1m</option>
          <option value="5m">5m</option>
          <option value="15m">15m</option>
          <option value="1h">1h</option>
          <option value="4h">4h</option>
          <option value="1d">1d</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Popups -->
  <div id="popup-overlay" class="overlay hidden" onclick="closeAllPopups()"></div>
  <div id="crypto-popup" class="popup hidden">
    <h3>Selecciona una criptomoneda</h3>
    <div id="crypto-list">Cargando...</div>
    <p>Solo puedes seleccionar una moneda.</p>
    <button onclick="closeAllPopups()">Cerrar</button>
  </div>
  <div id="threshold-popup" class="popup hidden">
    <h3>Configura los umbrales</h3>
    <label>Umbral superior (%): <input type="number" id="upper-threshold" step="0.1"></label><br>
    <label>Umbral inferior (%): <input type="number" id="lower-threshold" step="0.1"></label><br>
    <button onclick="saveThresholds()">Guardar</button>
    <button onclick="closeAllPopups()">Cerrar sin guardar</button>
  </div>
  <div id="alert-popup" class="popup hidden">
    <h3>Opciones de alerta</h3>
    <label><input type="checkbox" id="popup-alert" checked> Alertas en pantalla</label><br>
    <button onclick="closeAllPopups()">Cerrar</button>
  </div>
  <audio id="alert-sound">
    <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
  </audio>

  <script>
    let selectedSymbol = localStorage.getItem("symbol") || "BTCUSDT";
    let thresholds = JSON.parse(localStorage.getItem("thresholds")) || { upper: 2, lower: -2 };
    let timeframe = localStorage.getItem("timeframe") || "1m";
    let chart;

    document.getElementById("timeframe-select").value = timeframe;

    function changeTimeframe() {
      timeframe = document.getElementById("timeframe-select").value;
      localStorage.setItem("timeframe", timeframe);
      initChart();
    }

    async function openCryptoPopup() {
      document.getElementById("popup-overlay").classList.remove("hidden");
      document.getElementById("crypto-popup").classList.remove("hidden");
      const container = document.getElementById("crypto-list");
      container.innerHTML = "Cargando...";
      try {
        const res = await fetch("https://api.binance.com/api/v3/ticker/24hr");
        const data = await res.json();
        const filtered = data.filter(d => d.symbol.endsWith("USDT") && !d.symbol.includes("DOWN") && !d.symbol.includes("UP"));
        container.innerHTML = "";
        filtered.slice(0, 50).forEach(item => {
          const div = document.createElement("div");
          div.className = "crypto-option";
          div.innerText = `${item.symbol} - $${parseFloat(item.lastPrice).toFixed(2)} (${parseFloat(item.priceChangePercent).toFixed(2)}%)`;
          div.onclick = () => {
            selectedSymbol = item.symbol;
            localStorage.setItem("symbol", selectedSymbol);
            closeAllPopups();
            initChart();
          }
          container.appendChild(div);
        });
      } catch (err) {
        container.innerHTML = "Error al cargar criptomonedas.";
      }
    }

    function openThresholdPopup() {
      document.getElementById("popup-overlay").classList.remove("hidden");
      document.getElementById("threshold-popup").classList.remove("hidden");
      document.getElementById("upper-threshold").value = thresholds.upper;
      document.getElementById("lower-threshold").value = thresholds.lower;
    }

    function openAlertPopup() {
      document.getElementById("popup-overlay").classList.remove("hidden");
      document.getElementById("alert-popup").classList.remove("hidden");
    }

    function closeAllPopups() {
      document.querySelectorAll(".popup, .overlay").forEach(e => e.classList.add("hidden"));
    }

    function saveThresholds() {
      const upper = parseFloat(document.getElementById("upper-threshold").value);
      const lower = parseFloat(document.getElementById("lower-threshold").value);
      thresholds = { upper, lower };
      localStorage.setItem("thresholds", JSON.stringify(thresholds));
      closeAllPopups();
      initChart();
    }

    async function initChart() {
      const chartContainer = document.querySelector("#chart");
      chartContainer.innerHTML = "";

      try {
        const res = await fetch(`https://api.binance.com/api/v3/klines?symbol=${selectedSymbol}&interval=${timeframe}&limit=100`);
        const data = await res.json();
        const seriesData = data.map(d => ({
          x: new Date(d[0]),
          y: [parseFloat(d[1]), parseFloat(d[2]), parseFloat(d[3]), parseFloat(d[4])]
        }));

        const lastClose = seriesData[seriesData.length - 1].y[3];
        const upperLine = lastClose * (1 + thresholds.upper / 100);
        const lowerLine = lastClose * (1 + thresholds.lower / 100);

        if (chart) chart.destroy();
        chart = new ApexCharts(chartContainer, {
          chart: {
            type: 'candlestick',
            height: '100%',
            animations: { enabled: true },
            zoom: { enabled: true },
            toolbar: { show: true }
          },
          series: [{ data: seriesData }],
          xaxis: { type: 'datetime' },
          yaxis: {
            tooltip: { enabled: true },
            labels: { formatter: val => `$${val.toFixed(2)}` }
          },
          annotations: {
            yaxis: [
              {
                y: upperLine,
                borderColor: '#00ff00',
                label: {
                  borderColor: '#00ff00',
                  style: { color: '#00ff00', background: '#000' },
                  text: `+${thresholds.upper}%`
                }
              },
              {
                y: lowerLine,
                borderColor: '#ff0000',
                label: {
                  borderColor: '#ff0000',
                  style: { color: '#ff0000', background: '#000' },
                  text: `${thresholds.lower}%`
                }
              }
            ]
          }
        });

        chart.render();
      } catch (err) {
        chartContainer.innerHTML = '<p>Error al cargar el gr√°fico.</p>';
      }
    }

    if ("Notification" in window && Notification.permission !== "granted") {
      Notification.requestPermission();
    }

    window.onload = initChart;
  </script>
</body>
</html>
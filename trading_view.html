<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trading Alarm</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #0e111a;
      color: #fff;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }
    header {
      text-align: center;
      padding: 1rem;
      background-color: #1e222d;
      font-size: 1.5rem;
      font-weight: bold;
    }
    .container {
      display: flex;
      flex: 1;
    }
    .sidebar {
      width: 20%;
      background-color: #1e222d;
      padding: 1rem;
      box-sizing: border-box;
    }
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .live-chart {
      flex: 1;
      background-color: #131722;
    }
    .config {
      height: 12.5%;
      background-color: #1e222d;
      display: flex;
      align-items: center;
      padding: 0.5rem;
    }
    .config button {
      margin-right: 10px;
      padding: 0.5rem 1rem;
      background-color: #2c2f36;
      color: #fff;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .popup, .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #2c2f36;
      padding: 20px;
      border: 1px solid #444;
      z-index: 1000;
      color: white;
      max-height: 80vh;
      overflow-y: auto;
    }
    .popup h3, .modal h3 {
      margin-top: 0;
    }
    .overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      z-index: 999;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <header>Trading Alarm</header>
  <div class="container">
    <div class="sidebar">
      <h3>Trading Data</h3>
      <!-- Aquí se pueden añadir métricas adicionales -->
    </div>
    <div class="main">
      <div class="live-chart" id="chart"></div>
      <div class="config">
        <button onclick="openCryptoPopup()">Criptomonedas</button>
        <button onclick="openThresholdPopup()">Umbrales</button>
        <button onclick="openAlertPopup()">Alertas</button>
      </div>
    </div>
  </div>

  <!-- Popups -->
  <div id="popup-overlay" class="overlay hidden" onclick="closeAllPopups()"></div>
  <div id="crypto-popup" class="popup hidden">
    <h3>Selecciona una criptomoneda</h3>
    <div id="crypto-list"></div>
    <p>Solo puedes seleccionar una moneda.</p>
    <button onclick="closeAllPopups()">Cerrar</button>
  </div>

  <div id="threshold-popup" class="popup hidden">
    <h3>Configura los umbrales</h3>
    <label>Umbral superior (%): <input type="number" id="upper-threshold" step="0.1"></label><br>
    <label>Umbral inferior (%): <input type="number" id="lower-threshold" step="0.1"></label><br>
    <button onclick="saveThresholds()">Guardar</button>
    <button onclick="closeAllPopups()">Cerrar sin guardar</button>
  </div>

  <div id="alert-popup" class="popup hidden">
    <h3>Opciones de alerta</h3>
    <label><input type="checkbox" id="popup-alert" checked> Alertas en pantalla</label><br>
    <button onclick="closeAllPopups()">Cerrar</button>
  </div>

  <audio id="alert-sound">
    <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
  </audio>

  <script>
    let selectedSymbol = localStorage.getItem("symbol") || "BTCUSDT";
    let thresholds = JSON.parse(localStorage.getItem("thresholds")) || { upper: 2, lower: -2 };
    let chart, chartOptions;

    async function openCryptoPopup() {
      document.getElementById("popup-overlay").classList.remove("hidden");
      document.getElementById("crypto-popup").classList.remove("hidden");
      try {
        const res = await fetch("https://api.binance.com/api/v3/ticker/24hr");
        const data = await res.json();
        const filtered = data.filter(d => d.symbol.endsWith("USDT") && !d.symbol.includes("DOWN") && !d.symbol.includes("UP"));
        const container = document.getElementById("crypto-list");
        container.innerHTML = "";
        filtered.slice(0, 50).forEach(item => {
          const div = document.createElement("div");
          div.innerHTML = `${item.symbol} - $${parseFloat(item.lastPrice).toFixed(2)} (${parseFloat(item.priceChangePercent).toFixed(2)}%)`;
          div.style.cursor = "pointer";
          div.onclick = () => {
            selectedSymbol = item.symbol;
            localStorage.setItem("symbol", selectedSymbol);
            closeAllPopups();
            initChart();
          }
          container.appendChild(div);
        });
      } catch (e) {
        alert("Error al obtener datos de Binance. Reintentando...");
        setTimeout(openCryptoPopup, 3000);
      }
    }

    function openThresholdPopup() {
      document.getElementById("popup-overlay").classList.remove("hidden");
      document.getElementById("threshold-popup").classList.remove("hidden");
      document.getElementById("upper-threshold").value = thresholds.upper;
      document.getElementById("lower-threshold").value = thresholds.lower;
    }

    function openAlertPopup() {
      document.getElementById("popup-overlay").classList.remove("hidden");
      document.getElementById("alert-popup").classList.remove("hidden");
    }

    function closeAllPopups() {
      document.querySelectorAll(".popup, .overlay").forEach(e => e.classList.add("hidden"));
    }

    function saveThresholds() {
      const upper = parseFloat(document.getElementById("upper-threshold").value);
      const lower = parseFloat(document.getElementById("lower-threshold").value);
      thresholds = { upper, lower };
      localStorage.setItem("thresholds", JSON.stringify(thresholds));
      closeAllPopups();
    }

    async function initChart() {
      const chartContainer = document.querySelector("#chart");
      chartContainer.innerHTML = "";
      try {
        const res = await fetch(`https://api.binance.com/api/v3/klines?symbol=${selectedSymbol}&interval=1m&limit=500`);
        const data = await res.json();

        const ohlc = data.map(c => ({
          x: new Date(c[0]),
          y: [parseFloat(c[1]), parseFloat(c[2]), parseFloat(c[3]), parseFloat(c[4])]
        }));

        const basePrice = ohlc[ohlc.length - 1].y[3];
        const upperVal = basePrice * (1 + thresholds.upper / 100);
        const lowerVal = basePrice * (1 + thresholds.lower / 100);

        chartOptions = {
          chart: {
            type: 'candlestick',
            height: '100%',
            animations: { enabled: true },
            zoom: { enabled: true, type: 'x', autoScaleYaxis: true },
            toolbar: { show: true, tools: { zoom: true, zoomin: true, zoomout: true, reset: true } },
          },
          series: [{ data: ohlc }],
          xaxis: { type: 'datetime' },
          yaxis: {
            tooltip: { enabled: true },
            lines: [
              { value: upperVal, color: '#00ff00', dashArray: 4, label: { text: `+${thresholds.upper}%`, style: { color: '#00ff00' } } },
              { value: lowerVal, color: '#ff0000', dashArray: 4, label: { text: `${thresholds.lower}%`, style: { color: '#ff0000' } } }
            ]
          }
        };

        chart = new ApexCharts(chartContainer, chartOptions);
        chart.render();
        monitorPrice(basePrice);
      } catch (e) {
        chartContainer.innerHTML = "<p>Error al cargar el gráfico. Reintentando...</p>";
        setTimeout(initChart, 3000);
      }
    }

    async function monitorPrice(basePrice) {
      setInterval(async () => {
        try {
          const res = await fetch(`https://api.binance.com/api/v3/ticker/price?symbol=${selectedSymbol}`);
          const { price } = await res.json();
          const currentPrice = parseFloat(price);
          const change = ((currentPrice - basePrice) / basePrice) * 100;

          if (change >= thresholds.upper || change <= thresholds.lower) {
            const alertSound = document.getElementById("alert-sound");
            alertSound.play();
            if (document.getElementById("popup-alert").checked && Notification.permission === "granted") {
              new Notification(`Alerta de precio ${selectedSymbol}`, {
                body: `El precio ha cambiado ${change.toFixed(2)}%`,
              });
            }
          }
        } catch (e) {
          console.error("Error monitorizando precio", e);
        }
      }, 10000);
    }

    if ("Notification" in window && Notification.permission !== "granted") {
      Notification.requestPermission();
    }

    window.onload = initChart;
  </script>
</body>
</html>
